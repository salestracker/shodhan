# ADR 006: Service Worker Development Environment Strategy

## Status
Accepted

## Context
During the development of the SearchGPT project, persistent issues were encountered with Service Worker registration in the development environment. Specifically, a `SecurityError: MIME Type is not a JavaScript MIME type` error occurred for `dev-sw.js`, as Vite's development server consistently served the script as `text/html` instead of `application/javascript`. Multiple attempts to resolve this issue through custom middleware in `vite.config.ts`, various `vite-plugin-pwa` configurations (including `injectManifest` and `generateSW` strategies), and path adjustments failed to correct the MIME type serving issue. This prevented the Service Worker from registering in development mode, blocking the testing and development of critical cache synchronization features.

## Decision
To address the persistent MIME type issue and enable Service Worker functionality in development, the following strategy was adopted:
1. **Static Service Worker File for Development**: Create a static JavaScript file, `public/service-worker-dev.js`, in the `public` directory. This file contains the essential Service Worker logic adapted from `src/service-worker.ts`.
2. **Conditional Registration in Development Mode**: Modify `src/main.tsx` to conditionally register `public/service-worker-dev.js` only when running in development mode (detected via `import.meta.env.MODE === 'development'`). For production builds, the application continues to use the Service Worker generated by `vite-plugin-pwa` at `dev-dist/sw.js`.
3. **Disable `vite-plugin-pwa` Development Options**: Set `devOptions.enabled: false` in the `vite.config.ts` configuration for `vite-plugin-pwa` to prevent it from attempting to generate or serve the problematic `dev-sw.js` virtual module during development, avoiding conflicts with the manual registration of the static file.
4. **Adopt `generateSW` Strategy for Production Builds**: Use the `generateSW` strategy in `vite-plugin-pwa` for production builds, which resolved previous build errors related to manifest injection by allowing Workbox to generate the Service Worker automatically without requiring a specific source file for manifest injection.

## Rationale
1. **Bypass MIME Type Issue**: By using a static file in the `public` directory, Vite serves `public/service-worker-dev.js` as a regular static asset with the correct `application/javascript` MIME type, bypassing the problematic serving mechanism of `vite-plugin-pwa`'s `dev-sw.js` virtual module in development mode.
2. **Unblock Development Progress**: This workaround enables the Service Worker to register successfully in development, allowing for testing and iteration on cache synchronization features without being hindered by environment-specific issues.
3. **Preserve Production Integrity**: Maintaining the `vite-plugin-pwa` generated Service Worker for production ensures that the application benefits from Workbox's optimized caching and background sync capabilities in a deployed environment, while the development workaround remains isolated to local testing.
4. **Resolve Build Errors**: Switching to the `generateSW` strategy resolved persistent build errors encountered with `injectManifest`, such as "Unable to find a place to inject the manifest," by eliminating the need for manual manifest injection and allowing `vite-plugin-pwa` to handle Service Worker generation automatically for production builds.
5. **Practical and Efficient**: This approach leverages Vite's static asset serving for development simplicity, avoiding complex and ineffective middleware or plugin configuration tweaks, while ensuring a robust production setup.

## Consequences
- **Dual Service Worker Management**: Developers must maintain two Service Worker implementations: the static `public/service-worker-dev.js` for development and the `vite-plugin-pwa` configuration for production. Changes to Service Worker logic must be mirrored in both contexts to ensure consistency.
- **Potential for Discrepancies**: There is a risk of divergence between development and production Service Worker behavior if updates are not applied uniformly to both `public/service-worker-dev.js` and `src/service-worker.ts`. Rigorous testing is required to validate behavior across environments.
- **Limited `vite-plugin-pwa` Features in Development**: Disabling `devOptions.enabled` means that `vite-plugin-pwa`'s development-time features (like hot reloading of Service Worker changes) are unavailable, requiring manual updates to `public/service-worker-dev.js` and browser refreshes to test changes.
- **Future Resolution Encouraged**: This is a temporary workaround. Future updates to Vite or `vite-plugin-pwa` may resolve the underlying MIME type issue, at which point this strategy should be revisited to potentially reintegrate `vite-plugin-pwa`'s development Service Worker serving.

## Implementation Details
Key changes implemented:
1. **Static File Creation**: Created `public/service-worker-dev.js` with the necessary Service Worker logic, including message handling, sync operations, and background sync queuing, adapted from `src/service-worker.ts`.
2. **Conditional Registration Logic**: Updated `src/main.tsx` to check for development mode using `import.meta.env.MODE === 'development'` and register `/service-worker-dev.js` instead of the `vite-plugin-pwa` generated path. This ensures the static file is used only in development.
3. **Configuration Adjustment**: Modified `vite.config.ts` to set `devOptions.enabled: false` within the `VitePWA` plugin configuration, preventing `vite-plugin-pwa` from interfering with Service Worker registration in development mode.
4. **Strategy Switch**: Configured `vite-plugin-pwa` to use the `generateSW` strategy, resolving build errors by allowing automatic Service Worker generation for production. This involved removing conflicting `injectManifest` options and ensuring runtime caching rules (like background sync for `/sync-cache`) were defined appropriately.

This strategy successfully unblocked Service Worker development for SearchGPT, enabling the team to proceed with testing and refining cache synchronization while maintaining a clear path to production deployment.
